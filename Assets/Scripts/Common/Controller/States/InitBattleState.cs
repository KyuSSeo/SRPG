using System.Collections;
using System.Collections.Generic;
using UnityEngine;



// 전투 시작 시 초기 보드 설정 및 타일을 처리
public class InitBattleState :BattleState
{

    // 진입 시 기본 처리 후 코루틴 동작
    public override void Enter()
    {
        base.Enter();
        StartCoroutine(Init());
    }

    // 초기화 코루틴: 맵 로드, 초기 타일 선택, 다음 상태 전환을 순차적으로 수행
    // 맵 생성이 끝날 때 까지 기다뎌야 함.
    IEnumerator Init()
    {   
        //  타일 생성
        board.Load(levelData);
        Point p = new Point((int)levelData.tiles[0].x, (int)levelData.tiles[0].z);
        //  초기 타일 선택
        SelectTile(p);
        SpawnTestUnits();   // TODO : 임시 코드.

        yield return null;
        //  맵 초기화 완료 후 상태 전환
        owner.ChangeState<SelectUnitState>();
    }


    //  유닛 배치 테스트 함수
    private void SpawnTestUnits()
    {
        //  유닛의 이동 타입
        System.Type[] components = new System.Type[]
        {
            typeof(WalkMovement),
            typeof(FlyMovement),
            typeof(TeleportMovement)
        };

        for (int i = 0; i < 3; i++) 
        {
            GameObject instance = Instantiate(owner.heroPrefab) as GameObject;
            
            // 해당 유닛을 배치할 좌표 설정
            Point p = new Point((int)levelData.tiles[i].x, (int)levelData.tiles[i].z);
            
            //  유닛 컴포넌트를 가져와서 배치
            Unit unit = instance.GetComponent<Unit>();
            unit.Place(board.GetTile(p));
            unit.Match();

            //  이동 타입을 유닛에 추가
            Movement m = instance.AddComponent(components[i]) as Movement;
            m.range = 5;
            m.jumpHeight = 1;
            //  전투 리스트에 유닛 추가
            units.Add(unit);
        }
    }
}
